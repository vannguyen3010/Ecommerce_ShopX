@page "/gioi-thieu"
@inject IntroduceServices IntroduceServices
@rendermode InteractiveServer

<link rel="stylesheet" type="text/css" href="assets/css/style.min.css">

<main class="main">
    <!-- Start of Page Header -->
    <div class="page-header">
        <div class="container">
            <h1 class="page-title mb-0">Grid Sidebar</h1>
        </div>
    </div>
    <!-- End of Page Header -->
    <!-- Start of Breadcrumb -->
    <nav class="breadcrumb-nav mb-6">
        <div class="container">
            <ul class="breadcrumb">
                <li><a href="demo1.html">Home</a></li>
                <li><a href="blog.html">Blog</a></li>
                <li>Grid Sidebar</li>
            </ul>
        </div>
    </nav>
    <!-- End of Breadcrumb -->
    <!-- Start of Page Content -->
    <div class="page-content mb-10 pb-2">
        <div class="container">
            <div class="row gutter-lg">
                <div class="main-content">
                    <div class="row cols-sm-2">
                        @if(introduces != null && introduces.Any())
                        {
                            @foreach (var item in introduces)
                            {
                                <article class="post post-grid-type overlay-zoom mb-6 fashion">
                                    <figure class="post-media br-sm">
                                        <a href="post-single.html">
                                            <img src="@(string.IsNullOrEmpty(item.FilePath) ? "/Img_Dev/banner.png" : item.FilePath)" width="600"
                                                 height="420" alt="blog" onerror="this.onerror=null;this.src='/Img_Dev/banner.png';">
                                        </a>
                                    </figure>
                                    <div class="post-details">
                                        <div class="post-cats text-primary">
                                            <a href="#">@item.CategoryName</a>
                                        </div>
                                        <h4 class="post-title">
                                            <a href="post-single.html">@item.Name</a>
                                        </h4>
                                        <div class="post-content no_wrap_3">
                                            <p>
                                                @item.Description
                                            </p>
                                        </div>
                                        <div class="post-meta">
                                           <a href="#" class="post-date">@item.CreatedAt.ToString("dd-MM-yyyy")</a>
                                        </div>
                                    </div>
                                </article>
                            }
                        }
                       
                    </div>
                    <ul class="pagination justify-content-center">
                        <li class="prev @(currentPage == 1 ? "disabled" : "")">
                            <a href="javascript:void(0)" @onclick="PreviousPage" aria-label="Previous" tabindex="-1" aria-disabled="@(currentPage == 1)">
                                <i class="w-icon-long-arrow-left"></i> Prev
                            </a>
                        </li>
                            @for (int i = 1; i <= totalPages; i++)
                            {
                                var pageNumber = i;  // Tạo biến tạm để lưu giá trị của trang hiện tại

                                <li class="page-item @(pageNumber == currentPage ? "active" : "")">
                                    <a class="page-link" href="javascript:void(0)" @onclick="(() => ChangePage(pageNumber))">@pageNumber</a>
                                </li>
                            }

                        <li class="next @(currentPage == totalPages ? "disabled" : "")">
                            <a href="javascript:void(0)" @onclick="NextPage" aria-label="Next">
                                Next <i class="w-icon-long-arrow-right"></i>
                            </a>
                        </li>
                    </ul>
                </div>
                <!-- End of Main Content -->
                <aside class="sidebar right-sidebar blog-sidebar sidebar-fixed sticky-sidebar-wrapper">
                    <div class="sidebar-overlay">
                        <a href="#" class="sidebar-close">
                            <i class="close-icon"></i>
                        </a>
                    </div>
                    <a href="#" class="sidebar-toggle">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    <div class="sidebar-content">
                        <div class="sticky-sidebar">
                            <div class="widget widget-search-form">
                                <div class="widget-body">
                                    <form action="#" method="GET" class="input-wrapper input-wrapper-inline">
                                        <input type="text" class="form-control"
                                               placeholder="Search in Blog" autocomplete="off" required>
                                        <button class="btn btn-search">
                                            <i class="w-icon-search"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                            <!-- End of Widget search form -->
                            <div class="widget widget-categories mb-0">
                                <h3 class="widget-title bb-no">Categories</h3>
                                <ul class="widget-body filter-items search-ul">
                                    <li><a href="blog.html">Clothes</a></li>
                                    <li><a href="blog.html">Entertainment</a></li>
                                    <li><a href="blog.html">Fashion</a></li>
                                    <li><a href="blog.html">Lifestyle</a></li>
                                    <li><a href="blog.html">Others</a></li>
                                    <li><a href="blog.html">Shoes</a></li>
                                    <li><a href="blog.html">Technology</a></li>
                                </ul>
                            </div>
                            <!-- End of Widget categories -->
                            <div class="widget widget-posts">
                                <h3 class="widget-title bb-no">Popular Posts</h3>
                                <div class="widget-body">
                                    <div class="owl-carousel owl-theme owl-nav-top row cols-1" data-owl-options="{
                                                'nav': true,
                                                'dots': false,
                                                'margin': 20
                                            }">
                                        <div class="widget-col">
                                            <div class="post-widget mb-4">
                                                <figure class="post-media br-sm">
                                                    <img src="assets/images/blog/sidebar/1.jpg" alt="150" height="150" />
                                                </figure>
                                                <div class="post-details">
                                                    <div class="post-meta">
                                                        <a href="#" class="post-date">March 1, 2021</a>
                                                    </div>
                                                    <h4 class="post-title">
                                                        <a href="post-single.html">Fashion tells about who you are from external point</a>
                                                    </h4>
                                                </div>
                                            </div>
                                            <div class="post-widget mb-4">
                                                <figure class="post-media br-sm">
                                                    <img src="assets/images/blog/sidebar/2.jpg" alt="150" height="150" />
                                                </figure>
                                                <div class="post-details">
                                                    <div class="post-meta">
                                                        <a href="#" class="post-date">March 5, 2021</a>
                                                    </div>
                                                    <h4 class="post-title">
                                                        <a href="post-single.html">New found the men dress for summer</a>
                                                    </h4>
                                                </div>
                                            </div>
                                            <div class="post-widget mb-2">
                                                <figure class="post-media br-sm">
                                                    <img src="assets/images/blog/sidebar/3.jpg" alt="150" height="150" />
                                                </figure>
                                                <div class="post-details">
                                                    <div class="post-meta">
                                                        <a href="#" class="post-date">March 1, 2021</a>
                                                    </div>
                                                    <h4 class="post-title">
                                                        <a href="post-single.html">Cras ornare tristique elit</a>
                                                    </h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="widget-col">
                                            <div class="post-widget mb-4">
                                                <figure class="post-media br-sm">
                                                    <img src="assets/images/blog/sidebar/4.jpg" alt="150" height="150" />
                                                </figure>
                                                <div class="post-details">
                                                    <div class="post-meta">
                                                        <a href="#" class="post-date">March 1, 2021</a>
                                                    </div>
                                                    <h4 class="post-title">
                                                        <a href="post-single.html">Vivamus vestibulum ntulla nec ante</a>
                                                    </h4>
                                                </div>
                                            </div>
                                            <div class="post-widget mb-4">
                                                <figure class="post-media br-sm">
                                                    <img src="assets/images/blog/sidebar/5.jpg" alt="150" height="150" />
                                                </figure>
                                                <div class="post-details">
                                                    <div class="post-meta">
                                                        <a href="#" class="post-date">March 5, 2021</a>
                                                    </div>
                                                    <h4 class="post-title">
                                                        <a href="post-single.html">Fusce lacinia arcuet nulla</a>
                                                    </h4>
                                                </div>
                                            </div>
                                            <div class="post-widget mb-2">
                                                <figure class="post-media br-sm">
                                                    <img src="assets/images/blog/sidebar/6.jpg" alt="150" height="150" />
                                                </figure>
                                                <div class="post-details">
                                                    <div class="post-meta">
                                                        <a href="#" class="post-date">March 1, 2021</a>
                                                    </div>
                                                    <h4 class="post-title">
                                                        <a href="post-single.html">Comes a cool blog post with Images</a>
                                                    </h4>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>
    <!-- End of Page Content -->
</main>


@code {
    private IEnumerable<IntroduceDto> introduces;


    private Guid? categoryId = null;
    private string? keyword = null;
    private int currentPage = 1;
    private int pageSize = 1;

    private int totalPages;
    private int totalCount;

    protected override async Task OnInitializedAsync()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("pageNumber", out var page))
        {
            int.TryParse(page, out currentPage);
        }

        await LoadListIntroduces();
    }
    private async Task LoadListIntroduces()
    {
        var response = await IntroduceServices.GetListIntroduce(currentPage, pageSize, categoryId, keyword);

        if (response != null && response.Success)
        {
            introduces = response.Data.Introduces;
            totalCount = response.Data.TotalCount;
            totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
        }
        else
        {
            introduces = new List<IntroduceDto>();
        }
    }
    private async Task ChangePage(int page)
    {
        // Chỉ cập nhật nếu page khác currentPage
        if (page != currentPage)
        {
            currentPage = page;
            await UpdateUrlAndLoadProducts();
        }
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await UpdateUrlAndLoadProducts();
        }
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await UpdateUrlAndLoadProducts();
        }
    }


    private async Task OnPageSizeChanged(ChangeEventArgs e)
    {
        pageSize = int.Parse(e.Value.ToString());

        currentPage = 1;
        await UpdateUrlAndLoadProducts();
    }

    // Cập nhật URL và gọi API để lấy danh sách sản phẩm
    private async Task UpdateUrlAndLoadProducts()
    {
        // Tạo URL mới với thông tin trang hiện tại, kích thước trang, và giá lọc
        var queryParameters = new Dictionary<string, string>
            {
                ["pageNumber"] = currentPage.ToString(),
                ["pageSize"] = pageSize.ToString()
            };


        // Tạo URL query string
        var newUrl = QueryHelpers.AddQueryString("gioi-thieu", queryParameters!);
        NavigationManager.NavigateTo(newUrl, forceLoad: false);

        // Tải lại danh sách sản phẩm
        await LoadListIntroduces();
    }
}